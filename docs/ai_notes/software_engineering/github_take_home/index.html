<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Siobhán K Cronin  | System design challenge</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.41" />
    
    
      <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
    

    
    
      <link href="https://siobhankcronin.com/dist/css/app.ab4b67a3ea25990fa8279f3b7ef08b61.css" rel="stylesheet">
    

    
      <link rel="stylesheet" href="https://siobhankcronin.com/css/override.css">
    

    
        <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    

    
      
    

    

    <meta property="og:title" content="System design challenge" />
<meta property="og:description" content="Question 1 What properties of the CAP theorem would you prioritize for a cloud storage service (e.g. Amazon S3, Google Cloud Storage)? What tradeoffs would you have to make?
I approach the consistency vs. accessibility trade-off as an opportunity to clarify how our system might best serve our business goals. For example, in systems where it is mission-critical that all users see exactly the same records, such as systems serving critical care patient medical records, then I would prioritize consistency." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://siobhankcronin.com/ai_notes/software_engineering/github_take_home/" />
















<meta itemprop="name" content="System design challenge">
<meta itemprop="description" content="Question 1 What properties of the CAP theorem would you prioritize for a cloud storage service (e.g. Amazon S3, Google Cloud Storage)? What tradeoffs would you have to make?
I approach the consistency vs. accessibility trade-off as an opportunity to clarify how our system might best serve our business goals. For example, in systems where it is mission-critical that all users see exactly the same records, such as systems serving critical care patient medical records, then I would prioritize consistency.">



<meta itemprop="wordCount" content="1863">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="System design challenge"/>
<meta name="twitter:description" content="Question 1 What properties of the CAP theorem would you prioritize for a cloud storage service (e.g. Amazon S3, Google Cloud Storage)? What tradeoffs would you have to make?
I approach the consistency vs. accessibility trade-off as an opportunity to clarify how our system might best serve our business goals. For example, in systems where it is mission-critical that all users see exactly the same records, such as systems serving critical care patient medical records, then I would prioritize consistency."/>

      
    
  </head>

  <body class="ma0 avenir bg-white-90">

    
   
  

  <header>
    <div class="bg-sio-yellow">
      <nav class="bb bw2 b--mid-gray pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://siobhankcronin.com/" class="f3 fw6 no-underline black dib">
      Siobhán K Cronin
    </a>
    <div class="flex-l items-center">
      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw5 dib pr3">
            <a class="hover-gray no-underline mid-gray" href="/speaking" title="Speaking page">
              Speaking
            </a>
          </li>
          
          <li class="list f5 f4-ns fw5 dib pr3">
            <a class="hover-gray no-underline mid-gray" href="/projects" title="Projects page">
              Projects
            </a>
          </li>
          
          <li class="list f5 f4-ns fw5 dib pr3">
            <a class="hover-gray no-underline mid-gray" href="/index.html" title="AI Notes page">
              AI Notes
            </a>
          </li>
          
          <li class="list f5 f4-ns fw5 dib pr3">
            <a class="hover-gray no-underline mid-gray" href="/about" title="About page">
              About
            </a>
          </li>
          
          <li class="list f5 f4-ns fw5 dib pr3">
            <a class="hover-gray no-underline mid-gray" href="/contact/" title="Contact page">
              Contact
            </a>
          </li>
          
        </ul>
      
      



  <a href="//twitter.com/siokcronin" class="link-transition twitter link dib z-999 pt3 pr1 pt0-l mr2" title="Twitter link">
    <svg height="20px"  width="20px"  aria-labelledby="simpleicons-twitter-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title id="simpleicons-twitter-icon">Twitter icon</title><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg>

  </a>




  <a href="//linkedin.com/in/siobhankcronin" class="link-transition linkedin link dib z-999 pt3 pr1 pt0-l mr2" title="LinkedIn link">
    <svg height="20px"  width="20px"  aria-labelledby="simpleicons-linkedin-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title id="simpleicons-linkedin-icon">LinkedIn icon</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>

  </a>


  <a href="//github.com/siokcronin" class="link-transition github link dib z-999 pt3 pr1 pt0-l mr2" title="Github link">
    <svg height="20px"  width="20px"  aria-labelledby="simpleicons-github-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title id="simpleicons-github-icon">GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>

  </a>


  <a href="//medium.com/@siobhankcronin" class="link-transition medium link dib z-999 pt3 pt0-l mr2" title="Medium link">
    <svg height="20px"  width="20px" aria-labelledby="simpleicons-medium-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title id="simpleicons-medium-icon">Medium icon</title><path d="M2.846 6.36c.03-.295-.083-.586-.303-.784l-2.24-2.7v-.403H7.26l5.378 11.795 4.728-11.795H24v.403l-1.917 1.837c-.165.126-.247.333-.213.538v13.5c-.034.204.048.41.213.537l1.87 1.837v.403h-9.41v-.403l1.937-1.882c.19-.19.19-.246.19-.538V7.794l-5.39 13.688h-.727L4.278 7.794v9.174c-.052.386.076.774.347 1.053l2.52 3.06v.402H0v-.403l2.52-3.06c.27-.278.39-.67.326-1.052V6.36z"/></svg>

  </a>



    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  <article class="flex-l flex-wrap justify-between center">
    <header class="pt4 pa3 ph4-ns pb0 w-100 w-60-ns center">
      <p class="f6 b helvetica tracked">
          
        SOFTWARE ENGINEERING
      </p>
      <h1 class="f1 helvetica mb1">System design challenge</h1>
    </header>

    <main class="w-100 w-60-ns center nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pt4 pa3 ph4-ns pb0">

<h2 id="question-1">Question 1</h2>

<p><strong>What properties of the CAP theorem would you prioritize for a cloud storage service
(e.g. Amazon S3, Google Cloud Storage)? What tradeoffs would you have to make?</strong></p>

<p>I approach the consistency vs. accessibility trade-off as an opportunity to clarify
how our system might best serve our business goals. For example, in systems where
it is mission-critical that all users see exactly the same records, such as
systems serving critical care patient medical records, then I would prioritize consistency.
However, in services where users expect real-time access to information, such as Yelp &ldquo;closing soon&rdquo;
restaurant recommendations, I would prioritize accessibility.</p>

<p>It is wroth mentioning that the the venn diagram often used to depict
the CAP theorem can sometimes be a bit misleading. The need to
prioritize either consistency or availability emerges when we partition our data across
servers. You can imagine if you were updating and accessing data from a single database
on a single server, the conversation of consitency and availability would become
less pressing, as you would assume locking protocols would ensure consistency and
that the availability you had would be what you had.</p>

<h2 id="question-2">Question 2</h2>

<p><strong>You are part of a team that is responsible for a large, distributed web application.
Assume the architecture consists of multiple services running on Kubernetes, using
primarily MySQL for persistence, and some form of API and user-facing frontend.
Make whatever other assumptions about the system you wish.</strong></p>

<p>Let&rsquo;s assume there is a table for users in our MySQL database, and that writes
are processed by our master nodes and written and replicated to our replicas. Reads
can happen from any node.</p>

<p>Let&rsquo;s also assume we are using a messaging service like Kafka to coordinate communication
acros our microservices.</p>

<p>There are many aspects of our system we could explore, but in order to set up
question 3 well, let&rsquo;s address the following:</p>

<h4 id="log-in-system">Log-in system</h4>

<p>Perhaps the most important system design specification we need to understand in order
to address this triage challenge is log-in. Users manually enter their username or password,
or it is populated by a service like 1-Password, or they have a session active in the cache.</p>

<p>The steps of login are, generacially, identify if the user is in the user database
and if their submitted password matches the stored valid password.</p>

<p>For this challenge, let&rsquo;s assume our login request processing layer receives
a JSON file like this</p>

<pre><code>{ timestamp: '1000-01-01 00:00:00', 
  IP: '127.0.0.1/32',
  user: SioKCronin,
  password: IHeartData
}
</code></pre>

<p>The API might look something like this:</p>

<pre><code>SELECT IF( EXISTS(
             SELECT *
             FROM users
             WHERE `user` =  username AND 'password' = password), 1, 0)
</code></pre>

<h4 id="traffic-volume">Traffic volume</h4>

<p>I&rsquo;m going to use Yelp&rsquo;s mobile traffic as an example, as their persistence
layer consists of primarily MySQL clusters backed up to Redshift, and they
also orchestrate their deployment of Docker containers with Kubernetes (combined with Mesos
in their in-house system, PaaSTA).</p>

<p>Yelp sees an average of 32 million unique visitors a month on their mobile app.
If we estimate that 20% of Yelp&rsquo;s users stay logged into the app, these means
there are approximately 26 million users who log in through the app each month.
If we assume the distribution of log ins is constant across the entire day, that
would mean an average of 10 logins/second. While Yelp is used globally, the lioshare
of its users are in the United States, and they most like have observed hours of peak
usage, so it would be safe to assume the number of logins per second could excede
this initial estimate, perhaps extending up to 100s of logins/second, or even
thousands during peak time.</p>

<p>The imporant thing to track here is that a large number of users could be negatively
impacted by log-in latency, especially during peak hours, and similarly, any
rollout of software updates must take into account this steady, high-volume traffic.</p>

<h4 id="container-orchestration">Container orchestration</h4>

<p>Since we are using Kubernetes, our system is self-healing. If we have nodes down that are not auto-recovering,
this will point us either to our Kubernetes configuration itself or a problem with our cloud host.
We will not need to investigate individual nodes, except in our cluster logs to see why they failed.</p>

<h4 id="monitoring">Monitoring</h4>

<p>Let&rsquo;s assume we are using a monitoring service like Prometheus, so we have realtime data
on how our clusters are doing.</p>

<h2 id="question-3">Question 3</h2>

<p><strong>Users have recently begun complaining of slowness when logging in. Normally
logins take tens of milliseconds but many users are now seeing logins take
multiple seconds. Given full access to all the necessary systems, what are
your initial steps to investigate? Please include what questions you would ask,
which systems you&rsquo;d investigate first, which metrics you&rsquo;d look at, what commands
you might run, etc. Make sure to explain your reasoning.</strong></p>

<p>There are three overarching questions I would like to tackle:</p>

<ul>
<li>what happened?</li>
<li>how can we fix it?</li>
<li>how can we detect this issue sooner in the future?</li>
</ul>

<h3 id="what-happened">What happened?</h3>

<p>What follows is a cascading list of questions to ask and issues to address, but
I find it useful to allow one&rsquo;s creativity to at least take a 60 second stab at
what the major culprits might be. Set a timer, and get the intuitive guesses on
to the table so we can triage from there more dispationately.</p>

<p>For me these include:</p>

<ul>
<li>Perhaps what users are experiencing is isolated, and related to their specific networking environment.</li>
<li>Perhaps what users are experiencing is browser related, and tied to a recent upgrade.</li>
<li>Perhaps our database has reached a tipping point that we didn&rsquo;t anticipate in our load testing.</li>
<li>Perhaps there is another bug we can&rsquo;t quickly identify, and we should rollback our revisions until it is addressed.</li>
</ul>

<p>This not an exhaustive list, but more like a moment of ventilation to ensure first thoughts
do not vie for attention while a more systematic triage takes place.</p>

<p><strong>Which users have been affected?</strong></p>

<p>One of the critical pieces of information we have here is that users are successfully
logging in, it is just taking much longer. This rules out a host of directions we
would need to investigate if users were being denied log-in, or somehow their log-in
credentials were not accepted in the first place on the front-end (for instance, username
and password input fields not responding).</p>

<p>How many users have reported this issue, and what do they have in common? Geography?
Similar user names? Similiar log-in times? Android, IOS, desktop)? If similarities
are encountered, what parts of our system do they point to? Do the similarities relate
to our DB is sharded, thereby possibly indicating a problem in our load balancing or
in particular nodes in our cluster? Does the regionality of the issue point to possible
issues in our cloud hosting for that region?</p>

<p><strong>Does our internal testing replicate what the users are experiencing?</strong></p>

<p>Now that we have cornered the problem.</p>

<p>Namely, do our tests show what the user is experiencing, and we just overlooked it,
or does this issue we are triaging exhibit a novel situation we have not covered
with our tests? Can we see a record of this kind of activity in our integration testing?</p>

<p><strong>What is the state of our clusters?</strong></p>

<p>Are any nodes down? We have set them up to self-heal, so if they are down, what
would be preventing them from firing up? One situation might be&hellip;</p>

<p><strong>Has the system experienced any unusual spikes in traffic, and if so, what parts
of the system do we know this puts pressure on? How are those parts of our system
responding?</strong></p>

<p>Can our load balancers serving our client requests handle this traffic? Are our SQL
queries optimized to perform well under such system strain?</p>

<p><strong>Was something recently deployed that correlates with this phenomena?</strong></p>

<p>If we have not encountered an obvious error in our clusters or anomalies in
system traffic that would explain these log-in lags, it is time to evaluate when
did this change begin in order to debug it. Have we recently changed our cache
eviction strategy? This wouldn&rsquo;t explain why we&rsquo;ve gone from sub-second latency, to multi-second,
but it is important in our triaging to not assume our issue lies on a single fault line.
Perhaps multiple changes compounded to create the phenomena we are witnessing.</p>

<p>We can start but running a diff on the container itself</p>

<pre><code>Docker diff CONTAINER_ID
</code></pre>

<h3 id="how-we-can-we-resolve-this-issue">How we can we resolve this issue?</h3>

<p>This will of course depend on what we discovered above. If we found a bug in the code,
we could manually roll back to a previous version, but we must ask ourselves if restoring
the previous low latency log-in for these users is more important than the added benefit
of whatever else was included in our last revision (which will be undone if we rollback).
If so, we may choose to live with these low-latencies while we develop a revision
that will solve the problem at hand. Otherwise, it if we choose to rollback, here&rsquo;s
how we might proceed.</p>

<p>Like &lsquo;git reset &ndash;hard commitID&rsquo; in git version control, let&rsquo;s say we want to be
able to rollback to a specific previous revision in the deployment history.</p>

<p>We can first examine the history to obtain the number,</p>

<pre><code>kubectl rollout history deployment/nginx-deployment deployments &quot;nginx-deployment&quot;
</code></pre>

<p>and rollback to that specific revision.</p>

<pre><code class="language-python">kubectl rollout undo deployment/nginx-deployment --to-revision=2
deployment.extensions/nginx-deployment
</code></pre>

<p>This will pull the bug out of production, but doesn&rsquo;t answer our question.</p>

<p>To address whether a table reached a tipping point suspcicion, we will need to&hellip;</p>

<h3 id="how-might-we-detect-such-issues-sooner-going-forward">How might we detect such issues sooner going forward?</h3>

<p>The alarming aspect of this problem is that we did not catch it sooner.
We had to wait until our users complained, which is much too late.</p>

<p>It is possible our triage inspection will yield the results we are looking for, and the bug
can be fixed in short order. However, it may also be the case that the problem is more
complex, and will require further troubleshooting. In either case we are going to want
more rigourous test coverage that replicates the conditions that led to the slow
log-in our users experienced.</p>

<p>Once we feel we have solved the problem and it passes our tests, including load testing,
then we can set up a canary testing rollout to our nodes. This will requires us to
set a timeframe under which revisions will be monitored before further rollout takes place.
We should select time windows that afford the system a chance to monitor the kinds of interaction we expect
from our users. Given the volume we are assuming in this system, we can expect to see
most common activity within a 24 hour timeframe, or perhaps within an hour or minute.
These rollouts can be timed based on the frequency of the processing they most directly
address, or if the revision is more broad-reaching, than a typical range of user behaviors
should transpire during the monitoring phase.</p>

<p>And finally, we may find it worthwile to explore what researchers at Twitter have found to
be successful, which is to train an ML model to predict production success based
on performance in the testing environment. This layer is to listen to signals that
aren&rsquo;t detected by our test coverage, but that have historically predicted poor perfmance
in production.</p>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </main>
  </article>

    </main>
    <footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://siobhankcronin.com/" >
    &copy; 2018 Siobhán K Cronin
  </a>
  </div>
</footer>

    

  <script src="https://siobhankcronin.com/dist/js/app.3fc0f988d21662902933.js"></script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
  

  <script type="text/javascript">
    hljs.initHighlightingOnLoad();
  </script>


<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\[','\]']],
        processEscapes: true,
        processEnvironments: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        TeX: { equationNumbers: { autoNumber: "AMS" },
             extensions: ["AMSmath.js", "AMSsymbols.js"] }
      }
    });
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML">
</script>

  </body>
</html>
